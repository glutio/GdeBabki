@page "/review"
@inherits ViewBase<ReviewViewModel>
@inject ContextMenuService ContextMenuService

<BusyLoad Model="Model">
    <RadzenCard Style="width: 100%;">
        <h5>Accounts</h5>
        <RadzenCheckBoxList Data="Model.Accounts" @bind-Value="Model.SelectedAccounts" ValueProperty="Id"
                        TValue="Guid" TextProperty="FullName" Change="OnSelectedAccountsChangeAsync">
        </RadzenCheckBoxList>
    </RadzenCard>
    <RadzenCard>
        <h5>Shared Tags</h5>
        <div class="d-flex flex-row">
            <div>
                <EditTags @ref="refSharedTags" Tags="Model.SharedTags" BeforeSave="SaveSharedTagAsync" BeforeDelete="DeleteSharedTagAsync"></EditTags>
            </div>
            <div style="flex:auto"></div>
            <div>
                <RadzenButton Icon="cached" Click="ReloadTransactions"></RadzenButton>
            </div>
        </div>
    </RadzenCard>

    @{
        var activeTransactions = Model.ActiveTransactions;
        var selectedTransactions = Model.SelectedTransactions;
    }
    <RadzenDataGrid @ref="refGrid" TItem="Transaction" Data="Model.TransactionsView" AllowPaging="true" FilterMode="FilterMode.SimpleWithMenu" LoadData="Model.LoadData"
                AllowFiltering="true" AllowColumnResize="true" Count="Model.TransactionsCount" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center" AllowSorting="true" 
                SelectionMode="DataGridSelectionMode.Multiple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Filter="OnColumnFilterAsync" 
                @bind-Value="Model.SelectedTransactions" Page="OnPageAsync" Sort="OnSort" CellContextMenu="OnContextMenuAsync">
        <Columns>
            <RadzenDataGridColumn TItem="Transaction" Sortable="false" Filterable="false" Width="3rem">
                <HeaderTemplate>
                    <RadzenCheckBox TValue="bool" Value="!selectedTransactions.IsNullOrEmpty()"
                        Change="@(args => Model.SelectedTransactions = args ? Model.TransactionsQuery.ToList() : null)"></RadzenCheckBox>
                </HeaderTemplate>
                <Template>
                    <RadzenCheckBox TValue="bool" Value="selectedTransactions != null && selectedTransactions.Contains(context)" 
                    Change="args => refGrid.SelectRow(context)"></RadzenCheckBox>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Transaction" Property="State" Width="2rem" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
                <Template>
                    @if (context.State == GBTransactionState.Imported)
                    {
                        <span style="background-color:gold">&nbsp;</span>
                    }
                    else
                    {
                        <span style="background-color:green">&nbsp;</span>
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Transaction" Title="Date" Property="Date" Width="8rem" Filterable="true" FormatString="@GBUtility.TRANSACTION_DATE_FORMAT" 
                            TextAlign="TextAlign.Right" SortOrder="Model.DateSortOrder" FilterOperator="Model.DateFilterOperator" FilterValue="Model.DateFilterValue">
                <Template>
                    @(context.Date.Day)&nbsp;<b>@(context.Date.ToString("MMM"))&nbsp;@context.Date.Year</b>
                </Template>
                <FooterTemplate>
                    @if (Model.TransactionsCount > 0)
                    {
                        var grouping = activeTransactions.GroupBy(e => new DateTime(e.Date.Year, e.Date.Month, 1));
                        // times a month
                        var timesPerMonth = @grouping.Select(g => g.Count()).Average();
                        <b>@timesPerMonth.ToString("0.#") / </b>
                        // number of months
                        <b>@grouping.Count() / </b>
                        var monthlySpending = @grouping.Select(g => g.Sum(e => e.Amount)).Average();
                        // total per time
                        <b>@((monthlySpending/(decimal)timesPerMonth).ToCurrencyString()) / </b>
                        // total per month
                        <b>@monthlySpending.ToCurrencyString()</b>
                    }
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Transaction" Title="Description" Property="Description" Filterable="true" FilterValue="Model.DescriptionFilterValue" SortOrder="Model.DescriptionSortOrder" FilterOperator="Model.DescriptionFilterOperator" />
            <RadzenDataGridColumn TItem="Transaction" Title="Amount" Property="Amount" Width="8rem" Filterable="true" TextAlign="TextAlign.Right" FilterValue="Model.AmountFilterValue" SortOrder="Model.AmountSortOrder" FilterOperator="Model.AmountFilterOperator">
                <Template>
                    @if (context.Amount < 0)
                    {
                        <span style="color:red">@context.Amount.ToCurrencyString()</span>
                    }
                    else
                    {
                        <span style="color:green">@context.Amount.ToCurrencyString()</span>
                    }
                </Template>
                <FooterTemplate>
                    @if (Model.TransactionsCount > 0)
                    {
                        <b>@activeTransactions.Sum(e => e.Amount).ToCurrencyString() </b>
                    }
                </FooterTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn  @ref="refTagsFilterColumn" TItem="Transaction" Title="Tags" Property="Tags" Filterable="true" Sortable="false" FilterOperator="Model.TagsFilterOperator" >
                <FilterTemplate>
                    <EditTags @ref="refTagsFilter" Tags="Model.FilterTags" TagsUpdated="ReloadGridAsync"></EditTags>
                    <RadzenDataGridFilterMenu Column="refTagsFilterColumn" Grid="refGrid" TItem="Transaction" />
                </FilterTemplate>
                <Template>
                    <div @onclick:stopPropagation>
                        <EditTags Tags="@context.Tags" BeforeSave="e => SaveTagAsync(e, context)" BeforeDelete="e => DeleteTagAsync(e, context)" TagsUpdated="StateHasChanged">
                        </EditTags>
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</BusyLoad>

@code {
    [Parameter, SupplyParameterFromQuery]
    public Guid[] AccountIds { get; set; }

    RadzenDataGrid<Transaction> refGrid { get; set; }
    RadzenDataGridColumn<Transaction> refTagsFilterColumn { get; set; }

    EditTags refTagsFilter;
    EditTags refSharedTags;

    protected override void OnInitialized()
    {
        if (AccountIds != null && AccountIds.Length > 0) 
        {
            Model.SelectedAccounts = AccountIds;
            Model.IsLoaded = false;
        }

        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (refGrid != null)
        {
            await refGrid.GoToPage(Model.CurrentPage);
        }

        base.OnAfterRender(firstRender);
    }

    void OnPageAsync(PagerEventArgs args)
    {
        Model.CurrentPage = args.PageIndex;
    }

    async Task OnSelectedAccountsChangeAsync(IEnumerable<Guid> accounts)
    {
        await Model.OnSelectedAccountsChangeAsync();
        await ReloadGridAsync();
    }

    async Task OnColumnFilterAsync(DataGridColumnFilterEventArgs<Transaction> e)
    {
        if (e.Column == refTagsFilterColumn)
        {
            Model.TagsFilterOperator = e.FilterOperator;
        }

        Model.SelectedTransactions = null;
        await ReloadGridAsync();
    }

    void OnSort()
    {
        Model.IsFrozen = false;
    }

    void OnContextMenuAsync(DataGridCellMouseEventArgs<Transaction> args)
    {
        if (Model.SelectedTransactions.IsNullOrEmpty())
        {
            return;
        }

        ContextMenuService.Open(args, new List<ContextMenuItem>()
        {
            new ContextMenuItem() { Text = "Remove selected", Value = new Func<Task>(async () => {
                await Model.DeleteTransactionAsync();
                await ReloadGridAsync();
            }) }
        }, async e => await ((Func<Task>)e.Value)() );
     }


    async Task ReloadTransactions(MouseEventArgs args)
    {
        await ReloadGridAsync();
    }

    async Task ReloadGridAsync()
    {
        try
        {
            Model.IsBusy = true;
            Model.IsFrozen = false;
            await refGrid.Reload();

            var lastPage = Model.TransactionsCount / refGrid.PageSize;
            if (refGrid.CurrentPage > lastPage)
            {
                await refGrid.GoToPage(lastPage);
            }          
        }
        finally
        {
            Model.IsBusy = false;
        }
    }

    async Task SaveTagAsync(CancelEventArgs<string> e, Transaction transaction)
    {
        try
        {
            Model.IsBusy = true;
            await Model.SaveTagAsync(e.Value, transaction.Id);
        }
        catch
        {
            e.Cancel = true;
            throw;
        }
        finally
        {
            Model.IsBusy = false;
        }
    }

    async Task DeleteTagAsync(CancelEventArgs<string> e, Transaction transaction)
    {
        try
        {
            Model.IsBusy = true;
            await Model.DeleteTagAsync(e.Value, transaction.Id);
        }
        catch
        {
            e.Cancel = true;
            throw;
        }
        finally
        {
            Model.IsBusy = false;
        }
    }

    async Task SaveSharedTagAsync(CancelEventArgs<string> e)
    {
        try
        {
            Model.IsBusy = true;
            await Model.SaveSharedTagAsync(e.Value);
        }
        catch
        {
            e.Cancel = true;
            throw;
        }       
        finally
        {
            Model.IsBusy = false;
        }
    }

    async Task DeleteSharedTagAsync(CancelEventArgs<string> e)
    {
        try
        {
            Model.IsBusy = true;
            await Model.DeleteSharedTagAsync(e.Value);
        }
        catch
        {
            e.Cancel = true;
            throw;
        }
        finally
        {
            Model.IsBusy = false;
        }
    }
}
